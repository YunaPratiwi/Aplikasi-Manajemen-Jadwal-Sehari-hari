<?php

namespace App\Http\Controllers;

use App\Models\Category;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Validator;
use Illuminate\Support\Facades\DB;

class CategoryController extends Controller
{
    /**
     * Display a listing of categories.
     */
    public function index(Request $request)
    {
        $query = $this->userCategoriesQuery();

        // Apply search filter
        if ($request->filled('search')) {
            $query->where(function ($q) use ($request) {
                $q->where('name', 'like', "%{$request->search}%")
                  ->orWhere('description', 'like', "%{$request->search}%");
            });
        }

        // Show active categories by default
        if (!$request->has('show_inactive')) {
            $query->active();
        }

        $categories = $query->ordered()->withCount('tasks')->paginate(15);

        return view('categories.index', compact('categories'));
    }

    /**
     * Show the form for creating a new category.
     */
    public function create()
    {
        return view('categories.create');
    }

    /**
     * Store a newly created category.
     */
    public function store(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'name' => 'required|string|max:255',
            'description' => 'nullable|string|max:500',
            'color' => 'required|string|regex:/^#[0-9A-Fa-f]{6}$/',
            'icon' => 'nullable|string|max:50',
        ]);

        if ($validator->fails()) {
            return redirect()->back()
                ->withErrors($validator)
                ->withInput();
        }

        // Check if category name already exists for this user
        $existingCategory = $this->userCategoriesQuery()
            ->where('name', $request->name)
            ->first();

        if ($existingCategory) {
            return redirect()->back()
                ->withErrors(['name' => 'Kategori dengan nama ini sudah ada.'])
                ->withInput();
        }

        $categoryData = [
            'user_id' => Auth::id(),
            'name' => $request->name,
            'description' => $request->description,
            'color' => $request->color,
            'icon' => $request->icon,
            'sort_order' => Category::where('user_id', Auth::id())->max('sort_order') + 1,
            'is_active' => true,
        ];

        $category = Category::create($categoryData);

        return redirect()->route('categories.index')
            ->with('success', 'Kategori berhasil dibuat.');
    }

    /**
     * Display the specified category.
     */
    public function show(Category $category)
    {
        $this->authorize('view', $category);
        
        $category->load(['tasks' => function ($query) {
            $query->active()->with('category')->orderBy('sort_order');
        }]);

        $stats = $category->getStats();

        return view('categories.show', compact('category', 'stats'));
    }

    /**
     * Show the form for editing the specified category.
     */
    public function edit(Category $category)
    {
        $this->authorize('update', $category);
        
        return view('categories.edit', compact('category'));
    }

    /**
     * Update the specified category.
     */
    public function update(Request $request, Category $category)
    {
        $this->authorize('update', $category);

        $validator = Validator::make($request->all(), [
            'name' => 'required|string|max:255',
            'description' => 'nullable|string|max:500',
            'color' => 'required|string|regex:/^#[0-9A-Fa-f]{6}$/',
            'icon' => 'nullable|string|max:50',
            'is_active' => 'boolean',
        ]);

        if ($validator->fails()) {
            return redirect()->back()
                ->withErrors($validator)
                ->withInput();
        }

        // Check if category name already exists for this user (excluding current category)
        $existingCategory = $this->userCategoriesQuery()
            ->where('name', $request->name)
            ->where('id', '!=', $category->id)
            ->first();

        if ($existingCategory) {
            return redirect()->back()
                ->withErrors(['name' => 'Kategori dengan nama ini sudah ada.'])
                ->withInput();
        }

        $categoryData = [
            'name' => $request->name,
            'description' => $request->description,
            'color' => $request->color,
            'icon' => $request->icon,
            'is_active' => $request->boolean('is_active', true),
        ];

        $category->update($categoryData);

        return redirect()->route('categories.index')
            ->with('success', 'Kategori berhasil diperbarui.');
    }

    /**
     * Remove the specified category.
     */
    public function destroy(Category $category)
    {
        $this->authorize('delete', $category);
        
        // Check if category has tasks
        $taskCount = $category->tasks()->count();
        
        if ($taskCount > 0) {
            return redirect()->back()
                ->with('error', "Tidak dapat menghapus kategori karena masih memiliki {$taskCount} task. Pindahkan atau hapus task terlebih dahulu.");
        }

        $category->delete();

        return redirect()->route('categories.index')
            ->with('success', 'Kategori berhasil dihapus.');
    }
    
    /**
     * Show archived (inactive) categories.
     */
    public function archived(Request $request)
    {
        $query = $this->userCategoriesQuery()->onlyTrashed();
        
        // If using soft deletes, show only trashed categories
        if (method_exists(Category::class, 'bootSoftDeletes')) {
            $categories = $query->withCount('tasks')
                ->ordered()
                ->paginate(15);
        } else {
            // Fallback to is_active = false if not using soft deletes
            $categories = $query->where('is_active', false)
                ->withCount('tasks')
                ->ordered()
                ->paginate(15);
        }
        
        return view('categories.archived', compact('categories'));
    }

    /**
     * Reorder categories.
     */
    public function reorder(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'category_ids' => 'required|array',
            'category_ids.*' => 'exists:categories,id',
        ]);

        if ($validator->fails()) {
            return response()->json(['success' => false, 'errors' => $validator->errors()], 422);
        }

        DB::transaction(function () use ($request) {
            foreach ($request->category_ids as $index => $categoryId) {
                $category = Category::where('user_id', Auth::id())->findOrFail($categoryId);
                $category->update(['sort_order' => $index + 1]);
            }
        });

        return response()->json(['success' => true, 'message' => 'Urutan kategori berhasil diperbarui.']);
    }

    /**
     * Toggle category active status.
     */
    public function toggleActive(Category $category)
    {
        $this->authorize('update', $category);

        $category->update(['is_active' => !$category->is_active]);

        $status = $category->is_active ? 'diaktifkan' : 'dinonaktifkan';
        $message = "Kategori berhasil {$status}.";

        if (request()->expectsJson()) {
            return response()->json([
                'success' => true,
                'message' => $message,
                'is_active' => $category->is_active,
            ]);
        }

        return redirect()->back()->with('success', $message);
    }

    /**
     * Get category statistics.
     */
    public function stats(Category $category)
    {
        $this->authorize('view', $category);
        
        $stats = $category->getStats();

        return response()->json($stats);
    }

    /**
     * API endpoint for categories listing.
     */
    public function apiIndex(Request $request)
    {
        $query = $this->userCategoriesQuery();

        // Apply search filter
        if ($request->filled('search')) {
            $query->where(function ($q) use ($request) {
                $q->where('name', 'like', "%{$request->search}%")
                  ->orWhere('description', 'like', "%{$request->search}%");
            });
        }

        // Show active categories by default
        if (!$request->has('show_inactive')) {
            $query->active();
        }

        $categories = $query->ordered()
            ->withCount(['tasks', 'tasks as completed_tasks_count' => function ($query) {
                $query->where('is_completed', true);
            }])
            ->select('id', 'name', 'color', 'icon')
            ->get();

        return response()->json($categories);
    }

    /**
     * Bulk operations on categories.
     */
    public function bulkAction(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'action' => 'required|in:activate,deactivate,delete',
            'category_ids' => 'required|array|min:1',
            'category_ids.*' => 'exists:categories,id',
        ]);

        if ($validator->fails()) {
            return response()->json(['success' => false, 'errors' => $validator->errors()], 422);
        }

        $categories = $this->userCategoriesQuery()->whereIn('id', $request->category_ids);
        $count = $categories->count();

        if ($count === 0) {
            return response()->json(['success' => false, 'message' => 'Tidak ada kategori yang ditemukan.'], 404);
        }

        DB::transaction(function () use ($request, $categories) {
            switch ($request->action) {
                case 'activate':
                    $categories->update(['is_active' => true]);
                    break;
                case 'deactivate':
                    $categories->update(['is_active' => false]);
                    break;
                case 'delete':
                    // Check if any category has tasks
                    $categoriesWithTasks = $categories->withCount('tasks')->get()
                        ->filter(function ($category) {
                            return $category->tasks_count > 0;
                        });

                    if ($categoriesWithTasks->count() > 0) {
                        throw new \Exception('Beberapa kategori masih memiliki task dan tidak dapat dihapus.');
                    }

                    $categories->delete();
                    break;
            }
        });

        $actionMessages = [
            'activate' => 'diaktifkan',
            'deactivate' => 'dinonaktifkan',
            'delete' => 'dihapus',
        ];

        $message = "{$count} kategori berhasil {$actionMessages[$request->action]}.";

        return response()->json(['success' => true, 'message' => $message]);
    }

    /**
     * Export categories data.
     */
    public function export(Request $request)
    {
        $format = $request->get('format', 'csv');
        
        $categories = $this->userCategoriesQuery()
            ->withCount(['tasks', 'tasks as completed_tasks_count' => function ($query) {
                $query->where('is_completed', true);
            }])
            ->ordered()
            ->get();

        if ($format === 'csv') {
            return $this->exportCsv($categories);
        } elseif ($format === 'pdf') {
            return $this->exportPdf($categories);
        }

        return redirect()->back()->with('error', 'Format export tidak valid.');
    }

    /**
     * Export categories to CSV.
     */
    private function exportCsv($categories)
    {
        $filename = 'categories_' . date('Y-m-d_H-i-s') . '.csv';
        
        $headers = [
            'Content-Type' => 'text/csv',
            'Content-Disposition' => "attachment; filename=\"{$filename}\"",
        ];

        $callback = function () use ($categories) {
            $file = fopen('php://output', 'w');
            
            // CSV headers
            fputcsv($file, [
                'ID',
                'Nama',
                'Deskripsi',
                'Warna',
                'Icon',
                'Total Task',
                'Task Selesai',
                'Persentase Selesai',
                'Status',
                'Dibuat',
                'Diperbarui'
            ]);

            foreach ($categories as $category) {
                $completionRate = $category->tasks_count > 0 
                    ? round(($category->completed_tasks_count / $category->tasks_count) * 100, 1) 
                    : 0;

                fputcsv($file, [
                    $category->id,
                    $category->name,
                    $category->description,
                    $category->color,
                    $category->icon,
                    $category->tasks_count,
                    $category->completed_tasks_count,
                    $completionRate . '%',
                    $category->is_active ? 'Aktif' : 'Tidak Aktif',
                    $category->created_at->format('Y-m-d H:i:s'),
                    $category->updated_at->format('Y-m-d H:i:s'),
                ]);
            }

            fclose($file);
        };

        return response()->stream($callback, 200, $headers);
    }

    /**
     * Export categories to PDF.
     */
    private function exportPdf($categories)
    {
        // This would require a PDF library like DomPDF or TCPDF
        // For now, return a simple response
        return response()->json([
            'message' => 'PDF export akan diimplementasikan dengan library PDF seperti DomPDF.',
            'categories_count' => $categories->count()
        ]);
}

    /**
     * Get base query for the authenticated user's categories.
     */
    private function userCategoriesQuery()
    {
        return Category::query()->where('user_id', Auth::id());
    }
}
